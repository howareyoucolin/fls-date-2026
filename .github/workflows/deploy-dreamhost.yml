name: Deploy to DreamHost

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy-dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.DH_DEV_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.DH_DEV_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to DreamHost
        run: |
          rsync -avz --delete \
            --exclude='config.php' \
            --exclude='cache/' \
            --exclude='uploads/' \
            --exclude='logs/' \
            --exclude='.git/' \
            --exclude='.DS_Store' \
            --exclude='.dh-diag/' \
            --exclude='*.log' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes" \
            public/ \
            ${{ secrets.DH_DEV_USER }}@${{ secrets.DH_DEV_HOST }}:${{ secrets.DH_DEV_REMOTE_PATH }}

      - name: Generate config.php
        env:
          SSH_USER: ${{ secrets.DH_DEV_USER }}
          SSH_HOST: ${{ secrets.DH_DEV_HOST }}
          REMOTE_PATH: ${{ secrets.DH_DEV_REMOTE_PATH }}
        run: |
          cat > /tmp/config.php << EOF
          <?php if( ! defined('ROOT_PATH') ) die( 'Curiosity kills cat!' );

          //Debug mode.
          define( 'DEBUG', ${{ secrets.DH_DEV_DEBUG || 'true' }} );

          //Error reporting - set to true to display PHP errors on screen
          //Warning: Only enable in development/staging, never in production!
          define( 'ERROR_REPORTING', ${{ secrets.DH_DEV_ERROR_REPORTING || 'true' }} );

          //Define DB variables.
          define( 'DB_HOST', '${{ secrets.DH_DEV_DB_HOST }}' );
          define( 'DB_NAME', '${{ secrets.DH_DEV_DB_NAME }}' );
          define( 'DB_USERNAME', '${{ secrets.DH_DEV_DB_USERNAME }}' );
          define( 'DB_PASSWORD', '${{ secrets.DH_DEV_DB_PASSWORD }}' );

          //Site Url.
          define( 'SITE_URL', '${{ secrets.DH_DEV_SITE_URL }}' );
          EOF
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes /tmp/config.php ${SSH_USER}@${SSH_HOST}:${REMOTE_PATH}config.php
          rm -f /tmp/config.php

      - name: Generate robots.txt
        env:
          SSH_USER: ${{ secrets.DH_DEV_USER }}
          SSH_HOST: ${{ secrets.DH_DEV_HOST }}
          REMOTE_PATH: ${{ secrets.DH_DEV_REMOTE_PATH }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes ${SSH_USER}@${SSH_HOST} "cat > ${REMOTE_PATH}robots.txt << 'EOF'
          User-agent: *
          Disallow: /
          EOF"

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

  deploy-prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.DH_DEV_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.DH_DEV_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to DreamHost
        run: |
          rsync -avz --delete \
            --exclude='config.php' \
            --exclude='cache/' \
            --exclude='uploads/' \
            --exclude='logs/' \
            --exclude='.git/' \
            --exclude='.DS_Store' \
            --exclude='.dh-diag/' \
            --exclude='*.log' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes" \
            public/ \
            ${{ secrets.DH_PROD_USER }}@${{ secrets.DH_DEV_HOST }}:${{ secrets.DH_PROD_REMOTE_PATH }}

      - name: Generate config.php
        env:
          SSH_USER: ${{ secrets.DH_PROD_USER }}
          SSH_HOST: ${{ secrets.DH_DEV_HOST }}
          REMOTE_PATH: ${{ secrets.DH_PROD_REMOTE_PATH }}
        run: |
          cat > /tmp/config.php << EOF
          <?php if( ! defined('ROOT_PATH') ) die( 'Curiosity kills cat!' );

          //Debug mode.
          define( 'DEBUG', ${{ secrets.DH_PROD_DEBUG || 'false' }} );

          //Error reporting - set to true to display PHP errors on screen
          //Warning: Only enable in development/staging, never in production!
          define( 'ERROR_REPORTING', ${{ secrets.DH_PROD_ERROR_REPORTING || 'false' }} );

          //Define DB variables.
          define( 'DB_HOST', '${{ secrets.DH_DEV_DB_HOST }}' );
          define( 'DB_NAME', '${{ secrets.DH_DEV_DB_NAME }}' );
          define( 'DB_USERNAME', '${{ secrets.DH_DEV_DB_USERNAME }}' );
          define( 'DB_PASSWORD', '${{ secrets.DH_DEV_DB_PASSWORD }}' );

          //Site Url.
          define( 'SITE_URL', '${{ secrets.DH_PROD_SITE_URL }}' );
          EOF
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes /tmp/config.php ${SSH_USER}@${SSH_HOST}:${REMOTE_PATH}config.php
          rm -f /tmp/config.php

      - name: Generate robots.txt
        env:
          SSH_USER: ${{ secrets.DH_PROD_USER }}
          SSH_HOST: ${{ secrets.DH_DEV_HOST }}
          REMOTE_PATH: ${{ secrets.DH_PROD_REMOTE_PATH }}
          SITE_URL: ${{ secrets.DH_PROD_SITE_URL }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes ${SSH_USER}@${SSH_HOST} "cat > ${REMOTE_PATH}robots.txt << EOF
          User-agent: *
          Allow: /

          Sitemap: ${SITE_URL}/sitemap.xml
          EOF"

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
