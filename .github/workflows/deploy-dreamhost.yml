name: Deploy to DreamHost

on:
  push:
    branches:
      - dev
      - main

jobs:
  deploy-dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH key using printf to preserve formatting
          printf '%s\n' "${{ secrets.DH_DEV_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Verify key format (check first and last lines only)
          echo "Key format check:"
          head -1 ~/.ssh/deploy_key
          tail -1 ~/.ssh/deploy_key
          # Add host to known_hosts
          ssh-keyscan -H "${{ secrets.DH_DEV_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to DreamHost (Dev)
        run: |
          rsync -avz --delete \
            --exclude='config.php' \
            --exclude='cache/' \
            --exclude='uploads/' \
            --exclude='.git/' \
            --exclude='.DS_Store' \
            --exclude='.dh-diag/' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o UserKnownHostsFile=~/.ssh/known_hosts" \
            web/ \
            ${{ secrets.DH_DEV_USER }}@${{ secrets.DH_DEV_HOST }}:${{ secrets.DH_DEV_REMOTE_PATH }}

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

  deploy-prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Write SSH key using printf to preserve formatting
          printf '%s\n' "${{ secrets.DH_PROD_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # Verify key format (check first and last lines only)
          echo "Key format check:"
          head -1 ~/.ssh/deploy_key
          tail -1 ~/.ssh/deploy_key
          # Add host to known_hosts
          ssh-keyscan -H "${{ secrets.DH_PROD_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to DreamHost (Production)
        run: |
          rsync -avz --delete \
            --exclude='config.php' \
            --exclude='cache/' \
            --exclude='uploads/' \
            --exclude='.git/' \
            --exclude='.DS_Store' \
            --exclude='.dh-diag/' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o UserKnownHostsFile=~/.ssh/known_hosts" \
            web/ \
            ${{ secrets.DH_PROD_USER }}@${{ secrets.DH_PROD_HOST }}:${{ secrets.DH_PROD_REMOTE_PATH }}

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
